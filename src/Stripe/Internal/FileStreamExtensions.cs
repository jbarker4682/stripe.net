using System;
using System.IO;
using System.Text;

namespace Stripe.Internal
{
	/// <summary>
	/// Extension methods for <see cref="System.IO.FileInfo"/>.
	/// From http://www.paraesthesia.com/archive/2009/12/16/posting-multipartform-data-using-.net-webrequest.aspx/
	/// </summary>
	public static class FileStreamExtensions
	{
		/// <summary>
		/// Template for a file item in multipart/form-data format.
		/// </summary>
		public const string HeaderTemplate = "--{0}\r\nContent-Disposition: form-data; name=\"{1}\"; filename=\"{2}\"\r\nContent-Type: {3}\r\n\r\n";

		/// <summary>
		/// Writes a file to a stream in multipart/form-data format.
		/// </summary>
		/// <param name="fileStream">The file that should be written.</param>
		/// <param name="filename">The name of the file that should be written.</param>
		/// <param name="stream">The stream to which the file should be written.</param>
		/// <param name="mimeBoundary">The MIME multipart form boundary string.</param>
		/// <param name="mimeType">The MIME type of the file.</param>
		/// <param name="formKey">The name of the form parameter corresponding to the file upload.</param>        
		public static void WriteMultipartFormData(this Stream fileStream, string filename, Stream stream, string mimeBoundary, string mimeType, string formKey)
		{
			var header = String.Format(HeaderTemplate, mimeBoundary, formKey, filename, mimeType);
			var headerbytes = Encoding.UTF8.GetBytes(header);
			stream.Write(headerbytes, 0, headerbytes.Length);

			var buffer = new byte[1024];
			int bytesRead ;
			while ((bytesRead = fileStream.Read(buffer, 0, buffer.Length)) != 0)
			{
				stream.Write(buffer, 0, bytesRead);
			}
			fileStream.Close();

			var newlineBytes = Encoding.UTF8.GetBytes("\r\n");
			stream.Write(newlineBytes, 0, newlineBytes.Length);
		}
	}
}
